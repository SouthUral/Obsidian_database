[[Работа над путевыми листами]]


## Закрытие путевых листов
вызов производится из __api-v2/modules/waybills/actions.js__:
Запросы которые используются:
-  __closeWaybills_new__:
	- `GET_WAYBILLS_TIMES`, на вход функции передается список id. Функция забирает из представления `sh_waybills.v_waybills` __id, object_id, start_time, end_time__. Примечание __`start_time`, `end_time`__ которые забираются из представления, находятся в таблице __`sh_waybills.data`__:
		- `'select * from sh_waybills.get_waybills_times($1)'`
		по каждой строке из запроса производятся асинхронные запросы в БД: 
		- `GET_FUEL_END` на вход функции передаются параметры __start_time, end_time, object_id__. Сама функция находится в __архивной БД__. Функция возвращает среднее значение топлива за последние 10 сообщений от устройства.
			- `'select * from device.get_waybill_fuel_end($1, $2, $3)'`
		- `CALC_MILEAGE_BY_TRIPS` функция возвращает пробег техники в груженом состоянии, пробег забирается из таблицы ==sh_disp.trips==. На вход передаются параметры __object_id, start_time, end_time__.
			- `'select * from sh_waybills.calc_mileage_by_trips($1, $2, $3)'`
		- `CALC_MILEAGE_NO_TRUCKS`, функция возвращает полный пробег техники за указанный период. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`, ключ для json в котором указан текущий пробег (`mileage`) __.
			- `'select * from device.calc_mileage_no_truck($1, $2, $3, $4)'`
		- `CALC_MOTOHOURS`, функция возвращает моточасы техники за указанный период. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`__.
			- `'select * from device.calc_motohours($1, $2, $3)'`
	- `CALC_MILEAGE`, функция вычисляет пробег техники в груженом состоянии, в порожнем состоянии и в общий пробег. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`, пробег техники вычисленный функцией CALC_MILEAGE_BY_TRIPS__
		- `'select * from device.calc_mileage($1, $2, $3, $4)'`
	- `CLOSE_WAYBILL`
		- Описание: 
				Процедура осуществляет подбивку итогов по рейсам и простоям
		- Местоположение:
				Основная БД, `sh_waybills.close_waybill`
		- Принимаемые параметры:
			- `waybill_id` - `p_id` возвращает функция `sh_waybills.get_waybills_times($1)`
			- `user_id` - `p_user_id` этот параметр берется из запроса к сервису, присылает клиент
			- `start_time` - `p_start_time` с этого времени производится выборка из таблиц, этот параметр возвращает функция `sh_waybills.get_waybills_times($1)`
			- `end_time` - `p_end_time` время по которое производится выборка, этот параметр возвращает функция `sh_waybills.get_waybills_times($1)`
			- `fuel_end` - `p_fuel_end` средний показатель топлива (осталось топлива или наоборот использовано, я не знаю), этот параметр возвращает функция `device.get_waybill_fuel_end($1, $2, $3)`
			- `mileage` - `p_mileage jsonb`, это json в котором указан пробег груженым, пробег порожним, общий пробег. Этот параметр возвращает функция `device.calc_mileage($1, $2, $3, $4)`
			- `mileage_no_truck` - `p_mileage_no_truck jsonb` это пробег не самосвалов
			- `motohours` - `p_motohours` моточасы
		- Функциональность:
			- создает запись (объект закрытия) в таблице  `sh_waybills.closings`
			- добавление пробега в __параметры__:
				- добавляет для самосвальной техники в __параметры__ записи (
					- `empty` из параметра `mileage`
					- `load` из параметра `mileage`
					- `total` из параметра `mileage`
					- `end` из параметров `sh_waybills.v_waybills` колонка `params` + `total`)
				- для несамосвальной техники добавляет в __параметры__ записи (
					- `total` из параметра `mileage_no_truck`
					- `end` из параметров `sh_waybills.v_waybills` колонка `params` + `total`)
			- добавление моточасов в параметры:
				- если в __параметрах__ есть ключ `motohours` то добавляет в параметры записи:
					- `total` из параметра `motohours`
					- `end` сумма параметров `total` и  `_motohours_begin` который берется из параметров `sh_waybills.v_waybills`
			- добавление значений топлива в параметры:
				- если в __параметрах__ есть ключ `fuel1`:
					- формируется параметр `_fuel_begin` из __параметров__
					- производится запрос в таблицу ==sh_disp.refuellings== из запроса формируется параметр `_fuel_refuelling`
					- в __параметры__ добавляются записи:
						- `refuelling` это параметр `_fuel_refuelling` или 0
						- `end` это либо параметр `fuel_end` либо `_fuel_begin`
						- `usage` это сумма `_fuel_begin`, `_fuel_refuelling`, `end` 
			- производится подбивка суммарных итогов по рейсам и простоям
				- вызов процедуры `sh_waybills.calc_trips_summary(_waybill.id, _closing_id, _waybill.object_id, p_start_time, p_end_time)`
					- Описание:
						- процедура агрегирует данные по объекту и времени и добавляет в таблицу `sh_waybills.summaries_trips` агрегированную сводку параметров со всех рейсов, которые попали под выборку.
					- Функциональность:
						- удаляет строку из таблицы `sh_waybills.summaries_trips`
						- добавляет запись в таблицу `sh_waybills.summaries_trips` с данными из таблицы ==sh_disp.trips==
						- при возникновении ошибки добавляет запись в таблицу `sh_waybills.errors`
					- Используемые таблицы, процедуры, функции, представления:
						- ==sh_disp.trips==
				- вызов процедуры `sh_waybills.calc_idles_summary(_waybill.id, _closing_id, _waybill.object_id, p_start_time, p_end_time)`
					- Описание:
						- Процедура добавляет информацию по простоям за смену в таблицу `sh_waybills.summaries_idles`
					- Используемые таблицы, процедуры, функции, представления:
						- ==sh_disp.v_idles==
			- обновляется запись в таблице `sh_waybills.closings`
			- обновляется запись в таблице `sh_waybills.data`:
				- в не добавляются записи:
					- `closing_id` - id объекта закрытия
					- `params` - json, это параметры которые были собраны в теле процедуры
					- `start_time` - время начала смены (передается как параметр процедуры)
					- `end_time` - время окончания смены (передается как параметр процедуры)
			
		- `'call sh_waybills.close_waybill($1::int, $2::int, $3::timestamp, $4::timestamp, $5::numeric, $6::jsonb, $7::jsonb, $8::numeric)'` это основной вызов процедуры

## Создание путевых листов
вызов производится из __api-v2/modules/waybills/actions.js__:
Запросы которые используются:
- `NEW_WAYBILLS`
	- Запрос:
		- `call sh_waybills.add_waybills($1, $2, $3, $4)`
	- Принимаемые параметры:
		- `id` - `p_ids integer[]`
		- `date` - `p_shift_date date`
		- `shift` - `p_shift_num integer`
		- `overlap` - `p_overlap boolean DEFAULT false`
	- Описание:
		- Процедура создает для переданного списка `id` новые путевые листы
	- Функциональность:
		- Определение свободных границ (временных) для техники
		- Используется функция `sh_waybills.get_free_ranges(_object_id, p_shift_date, p_shift_num)` [[Схематичная карта работы модуля путевых листов#Получение свободных границ смены|Получение свободных границ смены]]
				- параметры функции:
					- `p_object_id` - идентификатор технического объекта
					- `p_shift_date` - дата смены
					- `p_shift_num` - номер смены
				- функция возвращает набор `tsrange` который содержит границы свободное времени для указанного объекта в указанную смену
		- Получение параметров путевого листа на основе дефолтных для данной модели техники
		- Перенос параметров из предыдущего путевого листа (при его наличии)
		- Создание нового путевого листа
			- добавление новой записи в  таблицу `sh_waybills.waybills`
				- Колонки:
					- `object_id` - идентификатор технического объекта, для которого создан путевой лист
					- `num` - номер путевого листа
					- `shift_date` - дата смены, для которой создан путевой лист
					- `shift_num` - номер смены, для которой создан путевой лист
			- добавление новой записи в таблицу `sh_waybills.data`
				- Колонки:
					- `waybill_id` - id записи в таблице `sh_waybills.waybills`, идентификатор путевого листа
					- `object_id` - id переданное  как параметр (из `p_ids`), идентификатор технического объекта, для которого создан путевой лист
					- `is_auto` - `true`, идентификатор указывающий, был ли путевой лист создан автоматически
					- `start_time` - время начала путевого листа (по факту начало смены)
						- Если флаг `p_overlap` равен `true`, то `start_time` и `end_time` равны началу и концу смены соответственно. В противном случае `start_time` и `end_time` равны соответствующими границами свободного времени.
						- Вызов функции ==`sh_data.shift_begin(p_shift_date, p_shift_num)`==
					- `end_time` - время окончания путевого листа (по факту конец смены)
						- Если флаг `p_overlap` равен `true`, то `start_time` и `end_time` равны началу и концу смены соответственно. В противном случае `start_time` и `end_time` равны соответствующими границами свободного времени.
						- Вызов функции ==`sh_data.shift_end(p_shift_date, p_shift_num)`==
					- `driver_id` - идентификатор водителя, связанного с путевым листом
					- `params` - параметры путевого листа
	- Итог:
		- Основной вызов:
			- Вызов процедуры:
				- `sh_waybills.add_waybills($1, $2, $3, $4)`
		- Вспомогательные процедуры/функции:
		- Таблицы из которых забирались данные:
		- Таблицы в которые добавлялись/обновлялись данные


# Таблицы
# Процедуры и функции
## Интерфейсные процедуры/функции

## Вспомогательные процедуры/функции
### Функции
#### `sh_waybills.get_free_ranges`
- Описание:
	- Получение свободных границ смены 
- Сигнатура функции:
	- `sh_waybills.get_free_ranges(p_object_id integer, p_shift_date date, p_shift_num integer)`
- Параметры функции:
	- `p_object_id` - идентификатор технического объекта
	- `p_shift_date` - дата смены
	- `p_shift_num` - номер смены
- Используемые функции/процедуры:
	- Внутренние:
	- Внешние:
		- `sh_data.shift_begin`
		- `sh_data.shift_end`
- Таблицы:
	- Таблицы из которых берутся данные:
	- Таблицы в которые производится запись:

### Процедуры

# Внешние зависимости
Здесь описаны таблицы процедуры/функции которые находятся в других схемах или в другой БД.

## Основная БД
### Схемы

#### sh_data

##### Таблицы

##### Процедуры/функции

###### `sh_data.shift_end`
- Описание:
	- 
- Сигнатура функции:
	- `sh_data.shift_end(timestamp without time zone, integer)`
- Параметры функции:
	- `timestamp without time zone` - дата, для которой нужно вычислить конечную временную метку;
	- `integer` - номер смены
- Таблицы:
	- Таблицы из которых берутся данные:
		- `sh_data.dir_shifts`


## Архивная БД

### Схемы

