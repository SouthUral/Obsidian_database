[[Работа над путевыми листами]]

## Закрытие путевых листов
вызов производится из __api-v2/modules/waybills/actions.js__:
Запросы которые используются:
-  __closeWaybills_new__:
	- `GET_WAYBILLS_TIMES`, на вход функции передается список id. Функция забирает из представления `sh_waybills.v_waybills` __id, object_id, start_time, end_time__. Примечание __`start_time`, `end_time`__ которые забираются из представления, находятся в таблице __`sh_waybills.data`__:
		- `'select * from sh_waybills.get_waybills_times($1)'`
		по каждой строке из запроса производятся асинхронные запросы в БД: 
		- `GET_FUEL_END` на вход функции передаются параметры __start_time, end_time, object_id__. Сама функция находится в __архивной БД__. Функция возвращает среднее значение топлива за последние 10 сообщений от устройства.
			- `'select * from device.get_waybill_fuel_end($1, $2, $3)'`
		- `CALC_MILEAGE_BY_TRIPS` функция возвращает пробег техники в груженом состоянии, пробег забирается из таблицы ==sh_disp.trips==. На вход передаются параметры __object_id, start_time, end_time__.
			- `'select * from sh_waybills.calc_mileage_by_trips($1, $2, $3)'`
		- `CALC_MILEAGE_NO_TRUCKS`, функция возвращает полный пробег техники за указанный период. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`, ключ для json в котором указан текущий пробег (`mileage`) __.
			- `'select * from device.calc_mileage_no_truck($1, $2, $3, $4)'`
		- `CALC_MOTOHOURS`, функция возвращает моточасы техники за указанный период. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`__.
			- `'select * from device.calc_motohours($1, $2, $3)'`
	- `CALC_MILEAGE`, функция вычисляет пробег техники в груженом состоянии, в порожнем состоянии и в общий пробег. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`, пробег техники вычисленный функцией CALC_MILEAGE_BY_TRIPS__
		- `'select * from device.calc_mileage($1, $2, $3, $4)'`
	- `CLOSE_WAYBILL`
		- Описание: 
				Процедура осуществляет подбивку итогов по рейсам и простоям
		- Местоположение:
				Основная БД, `sh_waybills.close_waybill`
		- Принимаемые параметры:
			- `waybill_id` - `p_id` возвращает функция `sh_waybills.get_waybills_times($1)`
			- `user_id` - `p_user_id` этот параметр берется из запроса к сервису, присылает клиент
			- `start_time` - `p_start_time` с этого времени производится выборка из таблиц, этот параметр возвращает функция `sh_waybills.get_waybills_times($1)`
			- `end_time` - `p_end_time` время по которое производится выборка, этот параметр возвращает функция `sh_waybills.get_waybills_times($1)`
			- `fuel_end` - `p_fuel_end` средний показатель топлива (осталось топлива или наоборот использовано, я не знаю), этот параметр возвращает функция `device.get_waybill_fuel_end($1, $2, $3)`
			- `mileage` - `p_mileage jsonb`, это json в котором указан пробег груженым, пробег порожним, общий пробег. Этот параметр возвращает функция `device.calc_mileage($1, $2, $3, $4)`
			- `mileage_no_truck` - `p_mileage_no_truck jsonb` это пробег не самосвалов
			- `motohours` - `p_motohours` моточасы
		- Функциональность:
			- создает запись (объект закрытия) в таблице  `sh_waybills.closings`
			- добавление пробега в параметры:
				- добавляет для самосвальной техники в параметры записи (
					- `empty` из параметра `mileage`
					- `load` из параметра `mileage`
					- `total` из параметра `mileage`
					- `end` из параметров `sh_waybills.v_waybills` колонка `params` + `total`)
				- для несамосвальной техники добавляет в параметры записи (
					- `total` из параметра `mileage_no_truck`
					- `end` из параметров `sh_waybills.v_waybills` колонка `params` + `total`)
			- добавление моточасов в параметры:
				- если в параметрах есть ключ `motohours` то добавляет в параметры записи:
					- `total` из параметра `motohours`
					- `end` сумма параметров `total` и  `_motohours_begin` который берется из параметров `sh_waybills.v_waybills`
			- добавление значений топлива в параметры:
				- если в параметрах есть ключ `fuel1`:
					- производится запрос в таблицу ==sh_disp.refuellings== из запроса формируется параметр `_fuel_refuelling`
					- в параметры добавляются записи:
						- `refuelling` это параметр `_fuel_refuelling` или 0
						- `end` 
			
		- `'call sh_waybills.close_waybill($1::int, $2::int, $3::timestamp, $4::timestamp, $5::numeric, $6::jsonb, $7::jsonb, $8::numeric)'` это основной вызов процедуры.
