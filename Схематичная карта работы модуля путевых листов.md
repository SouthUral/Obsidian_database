[[Работа над путевыми листами]]

## Закрытие путевых листов
вызов производится из __api-v2/modules/waybills/actions.js__:
Запросы которые используются:
-  __closeWaybills_new__:
	- `GET_WAYBILLS_TIMES`, на вход функции передается список id. Функция забирает из представления `sh_waybills.v_waybills` __id, object_id, start_time, end_time__. Примечание __`start_time`, `end_time`__ которые забираются из представления, находятся в таблице __`sh_waybills.data`__:
		- `'select * from sh_waybills.get_waybills_times($1)'`
		по каждой строке из запроса производятся асинхронные запросы в БД: 
		- `GET_FUEL_END` на вход функции передаются параметры __start_time, end_time, object_id__. Сама функция находится в __архивной БД__. Функция возвращает среднее значение топлива за последние 10 сообщений от устройства.
			- `'select * from device.get_waybill_fuel_end($1, $2, $3)'`
		- `CALC_MILEAGE_BY_TRIPS` функция возвращает пробег техники в груженом состоянии, пробег забирается из таблицы ==sh_disp.trips==. На вход передаются параметры __object_id, start_time, end_time__.
			- `'select * from sh_waybills.calc_mileage_by_trips($1, $2, $3)'`
		- `CALC_MILEAGE_NO_TRUCKS`, функция возвращает полный пробег техники за указанный период. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`, ключ для json в котором указан текущий пробег (`mileage`) __.
			- `'select * from device.calc_mileage_no_truck($1, $2, $3, $4)'`
		- `CALC_MOTOHOURS`, функция возвращает моточасы техники за указанный период. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`__.
			- `'select * from device.calc_motohours($1, $2, $3)'`
	- `CALC_MILEAGE`, функция вычисляет пробег техники в груженом состоянии, в порожнем состоянии и в общий пробег. Функция находится в __архивной БД__. На вход функции передаются параметры: __`object_id`, `start_time`, `end_time`, пробег техники вычисленный функцией CALC_MILEAGE_BY_TRIPS__
		- `'select * from device.calc_mileage($1, $2, $3, $4)'`
	- `CLOSE_WAYBILL`
		- `'call sh_waybills.close_waybill($1::int, $2::int, $3::timestamp, $4::timestamp, $5::numeric, $6::jsonb, $7::jsonb, $8::numeric)'` это основной вызов процедуры.
