[[Базы данных]]
Ключевая заметка для Раббита, но тут еще будет описание и т.д.
[ссылка на статью на habr](https://habr.com/ru/companies/slurm/articles/703060/)
### Базовая схема всех сущностей RabbitMQ
![[Pasted image 20231004150247.png]]
Слева направо:
 - __Publisher__ - публикует сообщение в ==Exchange== (обменник).
 - __Exchange__ - обменник. Сущность Rabbit, точка входа для публикаций всех сообщений.
 - __Binding__ - связь между __Exchange__ и очередью.
 - __Messages__ - сообщение, атомарная сущность.
 - __Consumer__ - подписчик, получает сообщение из очереди.

Другие термины:
 - __Publishing__ - процесс публикования сообщений в обменник.
 - __Consuming__ - процесс подписывания __consumer__ на очередь и получение им сообщений.
 - __Persistent__ - свойство сохранения данных при перезагрузке сервиса (иначе __стейт__).

### Publisher
Создает соединение (__connection__) по протоколу __AMQP__, в рамках соединения создает канал (__chanal__). В рамках одного соединения можно создать несколько каналов, ==но это не рекомендуется==.

> [!info] __Флаппинг каналов__
> Если __Publisher__ для каждого сообщения создаёт соединение (__chanal__) отправляет сообщение, закрывает канал, закрывает соединение - ==это очень плохо==. Rabbit становится плохо уже ~300 таких пересозданий каналов в секунду. Если нет возможности это исправить, то лучше использовать [amqproxy](https://hub.docker.com/r/cloudamqp/amqproxy), но не следует использовать его для __Consumer__.

__Publisher__ может декларировать почти все сущности (exchanges, queues, bindings ...). На практике лучше подходит стратегия декларирования всех нужных сущностей через __consumer__, но для каждого проекта это индивидуально.

> [!info] __Publisher__ всегда пишет в __exchange__

#### Параметры и флаги, которые может устанавливать __publisher__
##### __delivery_mode__
Это "признак персистентности" - означает, что сообщение будет сохранено на диске и не исчезнет в случае перезагрузки Rabbit:
 - __delivery_mode=1__ - не хранить сообщение, (работа идет быстрее);
 - __delivery_mode=2__ - хранить сообщение на диске, (работа идет медленнее, но надежнее).
##### __Routing Key__
__Publisher__ определяет:
 - __delivery_mode__ для каждого сообщения
 - __Routing Key__ для каждого сообщения - признак, по которому идет дальнейшая маршрутизация.
##### __confirm флаг__
__Publisher__ может выставлять ==__confirm флаг__ - отправлять указания Rabbit через отдельный канал подтверждения об успешной приемке сообщений.== Штука полезная, но снижает скорость работы, и трудно реализуется в однопоточных ЯП.

##### __mandatory флаг__
Это указание Rabbit складировать сообщения, не имеющие маршрута в какую-либо очередь в отдельный __Exchange__. Используется редко.

